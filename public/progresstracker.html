<!DOCTYPE html>
<meta charset=utf-8>
<html>
    <head>
        <title>Deadline Tracker</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.dev.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script>
            var socket = io();
            var roomName = document.location.href.substr(document.location.href.lastIndexOf('=') + 1);
            var previousCount = 0;

            socket.emit('newConnection', roomName);

            socket.on('newConnection', function(data) {
                updateGoal(data['goal']);
                updateCurrentCount(data['currentCount']);
                updateOverallGoal(data['overallgoal']);
                previousCount = parseInt(data['previouscount']);
                updateOverallCount();
                console.log(data['workers'])
                data['workers'].forEach(function(worker) {
                    addNewWorkerToList(worker.name);
                    setWorkerCounter(worker.name, worker.count, data['currentCount'])
                });
                // for (key in data['workers']) {
                //     addNewWorkerToList(key);
                //     setWorkerCounter(key, data['workers'][key], data['currentCount']);
                // }
            });

            socket.on('updateGoal', function(goal) {
                updateGoal(goal);
                updateRemaining();
            });

            socket.on('updateOverallGoal', function(goal) {
                updateOverallGoal(goal);
                updateRemaining();
            });

            socket.on('updatePreviousCount', function(count) {
                previousCount = count;
                updateOverallCount();
            });

            socket.on('resetRoom', function(roomID) {
                location.reload();
            });

            socket.on('setWorkerCounter', function(data) {
                setWorkerCounter(data['worker'], data['count'], data['currentCount']);
            });

            function updateRemaining() {
                $('#successMessage').hide();
                var remaining = parseInt($('#currentgoal').html())-parseInt($('#currentCount').html());
                $('#remaining').html(remaining);
                var remainingoverall = parseInt($('#currentoverallgoal').html())-(parseInt($('#currentCount').html())+parseInt(previousCount));
                $('#remainingoverall').html(remainingoverall);
                if (remaining == 0)
                    showSuccessMessage("The goal has been reached for today!!");
                if (remaining < 0)
                    showSuccessMessage("The goal has been surpassed by <b>" + (-1 * remaining) + "</b> for today!");
                if (remainingoverall <= 0) {
                    showSuccessMessage("Congratulations your goal has been reached!!");
                    disableCounterButtons();
                    disableAddWorkerGroup();

                } else {
                    enableCounterButtons();
                    enableAddWorkerGroup();
                }
            }

            function enableCounterButtons() {
                toggleCounterButtonsTo(false);
            }

            function disableCounterButtons() {
                toggleCounterButtonsTo(true);
            }

            function toggleCounterButtonsTo(flag) {
                toggleElements($('*[class*=counterbtn]'), flag);
            }

            function enableAddWorkerGroup() {
                toggleAddWorkerGroup(false);
            }

            function disableAddWorkerGroup() {
                toggleAddWorkerGroup(true);
            }

            function toggleAddWorkerGroup(flag) {
                toggleElements($('#addWorkerGroup').find('*'), flag);
            }

            function toggleElements(elements, flag) {
                elements.each(function() {
                    toggleElement(this, flag);
                });
            }

            function toggleElement(element, flag) {
                $(element).attr("disabled", flag);
            }

            function updateCurrentCount(count) {
                $('#currentCount').html(count);
                updateOverallCount();
            }

            function updateOverallCount() {
                var count = parseInt($('#currentCount').html()) + parseInt(previousCount);
                $('#currentOverallCount').html(count);
                updateRemaining();
            }

            function updateGoal(goal) {
                $('#currentgoal').html(goal);
            }

            function updateOverallGoal(goal) {
                $('#currentoverallgoal').html(goal);
            }

            function setGoal() {
                socket.emit("updateGoal", {'roomID':roomName, 'goal':$("#goalInput").val()});
                $("#goalInput").val("");
            }

            function setOverallGoal() {
                socket.emit("updateOverallGoal", {'roomID':roomName, 'overallgoal':$("#overallGoalInput").val()});
                $("#overallGoalInput").val("");
            }

            function setPreviousCount() {
                socket.emit("updatePreviousCount", {'roomID':roomName, 'previouscount':$("#previousCount").val()});
                $("#previousCount").val("");
            }

            function plusButtonClicked(worker) {
                socket.emit('addOne', {'roomID':roomName, 'worker':worker});
            }

            function minusButtonClicked(worker) {
                socket.emit('minusOne', {'roomID':roomName, 'worker':worker});
            }

            function setWorkerCounter(worker, count, currentCount) {
                $('#'+worker+'Counter').html(count);
                updateCurrentCount(currentCount);
            }

            function addNewWorkerToList(worker) {
                var minusButton = "<td><button class=\"btn counterbtn\" onclick='minusButtonClicked(\"" + worker + "\")'>-</button></td>";
                var counterInput = "<td style=\"text-align:center;\"><span id='" + worker + "Counter'>0</span></td>";
                var plusButton = "<td><button class=\"btn counterbtn\" onclick='plusButtonClicked(\"" + worker + "\")'>+</button></td>";
                var html = "<tr><td>" + worker + " </td>" + minusButton + counterInput + plusButton + "</tr>"

                $('#counters').append(html);
            }

            socket.on('newWorker', function (worker) {
                addNewWorkerToList(worker);
            });

            function addWorker() {
                socket.emit('newWorker', {'roomID':roomName, 'worker':$("#newWorker").val()});
                $("#newWorker").val("");
            }

            function showSuccessMessage(message) {
                $('#successMessage').html(message);
                $('#successMessage').show();
            }

            function Reset() {
                if (confirm("Are you sure you know what you are doing?")) {
                    console.log("puff")
                    socket.emit("reset", roomName);
                } 
            }

            function slowToggle() {
                root = $('#workerTable');
                var up = "<i class=\"fa fa-chevron-up\"></i></button>";
                var down = "<i class=\"fa fa-chevron-down\"></i></button>";
                $('#workerToggle').html($('#workerToggle').html().includes('up') ? down : up);
                root.find('tbody tr').each(function(i, tr) {
                    setTimeout(function() {
                        $(tr).toggle();
                    }, i*50)
                });
            }

        </script>
    </head>
    <body>
        <style>
            .counterbtn {
                width: 35px;
                height: 35px;
                padding-top: 2px;
            }
            .table > tbody > tr > td {
                 vertical-align: middle;
            }
        </style>
        <div class="container">
            <div class="col-md-10 mt-5">
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <div class="input-group mb-1">
                              <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Set Overall Goal:</span>
                              </div>
                              <input type="text" class="form-control" id="overallGoalInput">
                              <div class="input-group-append">
                                <button class="btn" onclick="setOverallGoal()">Submit</button>
                              </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="input-group mb-1">
                              <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Set Previous Count:</span>
                              </div>
                              <input type="text" class="form-control" id="previousCount">
                              <div class="input-group-append">
                                <button class="btn" onclick="setPreviousCount()">Submit</button>
                              </div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group mb-1">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default">Set Todays Goal:</span>
                      </div>
                      <input type="text" class="form-control" id="goalInput">
                      <div class="input-group-append">
                        <button class="btn" onclick="setGoal()">Submit</button>
                      </div>
                      
                    </div>
                    <div class="input-group mb-5" id="addWorkerGroup">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default">Add Worker:</span>
                      </div>
                      <input type="text" class="form-control" id="newWorker">
                      <div class="input-group-append">
                        <button class="btn" onclick="addWorker()">Submit</button>
                      </div>
                    </div>
                </div>
                <div class="col">
                    <div style="border: 1px solid rgba(0,0,0,.125);border-radius: .25rem;" class="mb-3">
                        <table class="table" id="workerTable" >
                            <thead>
                                <tr>
                                    <th style="width: 85%">Worker</th>
                                    <th style="width: 5%"></th>
                                    <th style="width: 5%"></th>
                                    <th style="width: 5%"><button onclick="slowToggle()" class="btn btn-light" id="workerToggle"><i class="fa fa-chevron-up"></i></button></th>
                                </tr>
                            </thead>
                            <tbody id="counters">

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Progress Tracker</h5>
                            <div class="mt-5 col">
                                <span class='font-weight-bold'>Current Goal Today: </span><span class="float-right" id="currentgoal">0</span>
                            </div>
                            <div class="col">
                                <span class='font-weight-bold'>Current Goal Overall: </span><span class="float-right" id="currentoverallgoal">0</span>
                            </div>
                            <hr>
                            <div class="col">
                                <span class='font-weight-bold'>Current Count Today: </span><span class="float-right" id="currentCount">0</span>
                            </div>
                            <div class="col">
                                <span class='font-weight-bold'>Current Count Overall: </span><span class="float-right" id="currentOverallCount">0</span>
                            </div>
                            <hr>
                            <div class="col">
                                <span class='font-weight-bold'>Remaining Today: </span><span class="float-right" id="remaining">0</span>
                            </div>
                            <div class="col">
                                <span class='font-weight-bold'>Remaining Overall: </span><span class="float-right" id="remainingoverall">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="alert alert-success mt-3" style="display: none;" id="successMessage" role="alert">
                      
                    </div>
                    <button class="btn col btn-danger mt-1 mb-1" onclick="Reset()">Reset</button>
                </div>
            </div>
        </div>
    </body>
</html>